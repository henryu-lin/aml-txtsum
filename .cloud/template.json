{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaces_txtsumdemo_name": {
            "defaultValue": "txtsumdemo",
            "type": "String"
        },
        "storageaccounts_san7rpvqes57qcu_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.storage/storageaccounts/san7rpvqes57qcu",
            "type": "String"
        },
        "vaults_kvn7rpvqes57qcu_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.keyvault/vaults/kvn7rpvqes57qcu",
            "type": "String"
        },
        "components_ain7rpvqes57qcu_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.insights/components/ain7rpvqes57qcu",
            "type": "String"
        },
        "registries_1e6415e66edd42b48e73c584377e3d34_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/UW-Embeddings/providers/Microsoft.ContainerRegistry/registries/1e6415e66edd42b48e73c584377e3d34",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.MachineLearningServices/workspaces",
            "apiVersion": "2021-04-01",
            "name": "[parameters('workspaces_txtsumdemo_name')]",
            "location": "eastus",
            "sku": {
                "name": "Basic",
                "tier": "Basic"
            },
            "identity": {
                "principalId": "4b042a6a-dc89-40e9-aee9-3bc7df8bd230",
                "tenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
                "type": "SystemAssigned"
            },
            "properties": {
                "friendlyName": "[parameters('workspaces_txtsumdemo_name')]",
                "storageAccount": "[parameters('storageaccounts_san7rpvqes57qcu_externalid')]",
                "keyVault": "[parameters('vaults_kvn7rpvqes57qcu_externalid')]",
                "applicationInsights": "[parameters('components_ain7rpvqes57qcu_externalid')]",
                "hbiWorkspace": false,
                "containerRegistry": "[parameters('registries_1e6415e66edd42b48e73c584377e3d34_externalid')]",
                "allowPublicAccessWhenBehindVnet": false,
                "discoveryUrl": "https://eastus.api.azureml.ms/discovery"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/gpu-v100-4')]",
            "location": "eastus",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "disableLocalAuth": false,
                "computeType": "AmlCompute",
                "computeLocation": "eastus",
                "properties": {
                    "vmSize": "STANDARD_NC6S_V3",
                    "vmPriority": "Dedicated",
                    "scaleSettings": {
                        "maxNodeCount": 2,
                        "minNodeCount": 0,
                        "nodeIdleTimeBeforeScaleDown": "PT5M"
                    },
                    "remoteLoginPortPublicAccess": "Enabled",
                    "osType": "Linux",
                    "isolatedNetwork": false,
                    "enableNodePublicIp": true
                }
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/gpu-v100-8-lp')]",
            "location": "eastus",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "disableLocalAuth": false,
                "computeType": "AmlCompute",
                "computeLocation": "eastus",
                "properties": {
                    "vmSize": "STANDARD_ND40RS_V2",
                    "vmPriority": "LowPriority",
                    "scaleSettings": {
                        "maxNodeCount": 1,
                        "minNodeCount": 0,
                        "nodeIdleTimeBeforeScaleDown": "PT5M"
                    },
                    "remoteLoginPortPublicAccess": "Enabled",
                    "osType": "Linux",
                    "isolatedNetwork": false,
                    "enableNodePublicIp": true
                }
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/data",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/hf-samsum')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "properties": {},
                "tags": {}
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/azureml_globaldatasets')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "contents": {
                    "contentsType": "AzureBlob",
                    "accountName": "mmstorageeastus",
                    "containerName": "globaldatasets",
                    "endpoint": "core.windows.net",
                    "protocol": "https",
                    "credentials": {
                        "credentialsType": "Sas"
                    }
                },
                "isDefault": false
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/workspaceblobstore')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "contents": {
                    "contentsType": "AzureBlob",
                    "accountName": "san7rpvqes57qcu",
                    "containerName": "azureml-blobstore-1e6415e6-6edd-42b4-8e73-c584377e3d34",
                    "endpoint": "core.windows.net",
                    "protocol": "https",
                    "credentials": {
                        "credentialsType": "AccountKey"
                    }
                },
                "isDefault": true
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/workspacefilestore')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "contents": {
                    "contentsType": "AzureFile",
                    "accountName": "san7rpvqes57qcu",
                    "containerName": "azureml-filestore-1e6415e6-6edd-42b4-8e73-c584377e3d34",
                    "endpoint": "core.windows.net",
                    "protocol": "https",
                    "credentials": {
                        "credentialsType": "AccountKey"
                    }
                },
                "isDefault": false
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/environments",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/hf-gpu')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "properties": {},
                "tags": {}
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/environments/versions",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/hf-gpu/1')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces/environments', parameters('workspaces_txtsumdemo_name'), 'hf-gpu')]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]"
            ],
            "properties": {
                "tags": {},
                "properties": {},
                "isAnonymous": false,
                "docker": {
                    "platform": {
                        "operatingSystemType": "Linux"
                    },
                    "dockerSpecificationType": "Build",
                    "dockerfile": "# Copyright (c) Microsoft Corporation. All rights reserved.\n# Licensed under the MIT License.\n\nFROM mcr.microsoft.com/azureml/o16n-base/python-assets:20210428.36856618 AS inferencing-assets\n\n# Tag: cuda:11.0.3-devel-ubuntu18.04\n# Env: CUDA_VERSION=11.1.1\n# Env: NCCL_VERSION=2.8.4\n# Env: CUDNN_VERSION=8.0.5.39\n\nFROM nvidia/cuda:11.1.1-cudnn8-devel-ubuntu18.04\n\nUSER root:root\n\nENV com.nvidia.cuda.version $CUDA_VERSION\nENV com.nvidia.volumes.needed nvidia_driver\nENV LANG=C.UTF-8 LC_ALL=C.UTF-8\nENV DEBIAN_FRONTEND noninteractive\nENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64\nENV NCCL_DEBUG=INFO\nENV HOROVOD_GPU_ALLREDUCE=NCCL\n\n# Install Common Dependencies\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends \\\n    # SSH and RDMA\n    libmlx4-1 \\\n    libmlx5-1 \\\n    librdmacm1 \\\n    libibverbs1 \\\n    libmthca1 \\\n    libdapl2 \\\n    dapl2-utils \\\n    openssh-client \\\n    openssh-server \\\n    redis \\\n    iproute2 && \\\n    # Others\n    apt-get install -y \\\n    build-essential \\\n    bzip2 \\\n    libbz2-1.0 \\\n    systemd \\\n    git \\\n    wget \\\n    cpio \\\n    pciutils \\\n    libnuma-dev \\\n    ibutils \\\n    ibverbs-utils \\ \n    rdmacm-utils \\\n    infiniband-diags \\\n    perftest \\\n    librdmacm-dev \\\n    libibverbs-dev \\\n    libsm6 \\\n    libxext6 \\\n    libxrender-dev \\\n    libssl1.0.0 \\\n    linux-image-aws \\ \n    linux-image-azure \\ \n    linux-image-generic \\\n    linux-image-kvm \\\n    linux-image-lowlatency \\\n    linux-image-virtual \\\n    linux-image-gke \\\n    linux-image-oem \\\n    slapd \\\n    perl \\ \n    ca-certificates \\\n    apt \\\n    p11-kit \\\n    libp11-kit0 \\\n    tar \\\n    libzstd1 \\\n    libglib2.0-0 \\\n    libnettle6 \\\n    fuse && \\\n    apt-get clean -y && \\\n    rm -rf /var/lib/apt/lists/*\n\n# Inference\n# Copy logging utilities, nginx and rsyslog configuration files, IOT server binary, etc.\nCOPY --from=inferencing-assets /artifacts /var/\nRUN /var/requirements/install_system_requirements.sh && \\\n    cp /var/configuration/rsyslog.conf /etc/rsyslog.conf && \\\n    cp /var/configuration/nginx.conf /etc/nginx/sites-available/app && \\\n    ln -s /etc/nginx/sites-available/app /etc/nginx/sites-enabled/app && \\\n    rm -f /etc/nginx/sites-enabled/default\nENV SVDIR=/var/runit\nENV WORKER_TIMEOUT=300\nEXPOSE 5001 8883 8888\n\n# Conda Environment\nENV MINICONDA_VERSION py37_4.9.2\nENV PATH /opt/miniconda/bin:$PATH\nRUN wget -qO /tmp/miniconda.sh https://repo.continuum.io/miniconda/Miniconda3-${MINICONDA_VERSION}-Linux-x86_64.sh && \\\n    bash /tmp/miniconda.sh -bf -p /opt/miniconda && \\\n    conda clean -ay && \\\n    rm -rf /opt/miniconda/pkgs && \\\n    rm /tmp/miniconda.sh && \\\n    find / -type d -name __pycache__ | xargs rm -rf\n\n# Open-MPI-UCX installation\nRUN mkdir /tmp/ucx && \\\n    cd /tmp/ucx && \\\n\twget -q https://github.com/openucx/ucx/releases/download/v1.6.1-rc2/ucx-1.6.1.tar.gz && \\\n\ttar zxf ucx-1.6.1.tar.gz && \\\n\tcd ucx-1.6.1 && \\\n\t./configure --prefix=/usr/local --enable-optimizations --disable-assertions --disable-params-check --enable-mt && \\\n\tmake -j $(nproc --all) && \\\n\tmake install && \\\n\trm -rf /tmp/ucx\n\n# Open-MPI installation\nENV OPENMPI_VERSION 4.1.0\nRUN mkdir /tmp/openmpi && \\\n    cd /tmp/openmpi && \\\n    wget https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-${OPENMPI_VERSION}.tar.gz && \\\n    tar zxf openmpi-${OPENMPI_VERSION}.tar.gz && \\\n    cd openmpi-${OPENMPI_VERSION} && \\\n    ./configure --with-ucx=/usr/local/ --enable-mca-no-build=btl-uct --enable-orterun-prefix-by-default && \\\n    make -j $(nproc) all && \\\n    make install && \\\n    ldconfig && \\\n    rm -rf /tmp/openmpi\t\n\t\n# Msodbcsql17 installation\nRUN apt-get update && \\\n    apt-get install -y curl && \\\n    curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - && \\\n    curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list > /etc/apt/sources.list.d/mssql-release.list && \\\n    apt-get update && \\\n    ACCEPT_EULA=Y apt-get install -y msodbcsql17\n\n#Cmake Installation\nRUN apt-get update && \\\n    apt-get install -y cmake"
                },
                "condaFile": "{\n  \"channels\": [\n    \"pytorch\",\n    \"nvidia\",\n    \"conda-forge\"\n  ],\n  \"dependencies\": [\n    \"python=3.8\",\n    \"pytorch=1.8.1\",\n    \"cudatoolkit=11.1\",\n    \"pip\",\n    {\n      \"pip\": [\n        \"numpy\",\n        \"nltk\",\n        \"protobuf\",\n        \"py7zr\",\n        \"sentencepiece\",\n        \"datasets\",\n        \"git+https://github.com/huggingface/transformers\",\n        \"rouge-score\",\n        \"mlflow\",\n        \"azureml-mlflow\",\n        \"fairscale\",\n        \"deepspeed\",\n        \"codecarbon\"\n      ]\n    }\n  ],\n  \"name\": \"azureml_601445831ecbb633fa034000577e4525\"\n}"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/data/versions",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/hf-samsum/1')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces/data', parameters('workspaces_txtsumdemo_name'), 'hf-samsum')]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces/datastores', parameters('workspaces_txtsumdemo_name'), 'workspaceblobstore')]"
            ],
            "properties": {
                "tags": {},
                "properties": {},
                "isAnonymous": false,
                "datastoreId": "[resourceId('Microsoft.MachineLearningServices/workspaces/datastores', parameters('workspaces_txtsumdemo_name'), 'workspaceblobstore')]",
                "path": "az-ml-artifacts/0de2cac8a96e39b6f084542b2f369071/hf-samsum",
                "datasetType": "Simple"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/jobs",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumdemo_name'), '/68bec586-ce0b-40bb-8d00-eb0cca5c10c9')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name'))]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces/computes', parameters('workspaces_txtsumdemo_name'), 'gpu-v100-8-lp')]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces/environments/versions', parameters('workspaces_txtsumdemo_name'), 'hf-gpu', '1')]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces/data/versions', parameters('workspaces_txtsumdemo_name'), 'hf-samsum', '1')]"
            ],
            "properties": {
                "description": "Finetune an encoder-decoder Transformer (BART) for dialogue summarization (SAMSum) with Hugging Face (PyTorch).",
                "tags": {
                    "_aml_system_ComputeTargetStatus": "{\"AllocationState\":\"steady\",\"PreparingNodeCount\":0,\"RunningNodeCount\":0,\"CurrentNodeCount\":0}"
                },
                "properties": {
                    "mlflow.source.git.repoURL": "git@github.com:henryu-lin/greenai-dev.git",
                    "mlflow.source.git.branch": "main",
                    "mlflow.source.git.commit": "0fe0eea249219cf5d6eac1d120ae1a34a107e71d",
                    "azureml.git.dirty": "True",
                    "_azureml.ComputeTargetType": "amlcompute",
                    "ContentSnapshotId": "627ac25e-4728-41d4-951c-739a75778359",
                    "ProcessInfoFile": "azureml-logs/process_info.json",
                    "ProcessStatusFile": "azureml-logs/process_status.json"
                },
                "jobType": "Command",
                "compute": {
                    "target": "[resourceId('Microsoft.MachineLearningServices/workspaces/computes', parameters('workspaces_txtsumdemo_name'), 'gpu-v100-8-lp')]",
                    "instanceCount": 1,
                    "isLocal": false
                },
                "experimentName": "hf-pytorch-demo",
                "codeId": "[concat(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumdemo_name')), '/codes/2d3b9772-73cc-4e97-a76e-5ffe618ab807/versions/1')]",
                "command": "python main.py  --model_name_or_path \"facebook/bart-large\"  --config_name \"./configs/bart-xsum-config.json\"  --dataset_name \"samsum\"  --dataset_path $AZURE_ML_INPUT_corpus  --max_source_length 512  --max_target_length 90  --fp16 True  --seed 1  --per_device_train_batch_size 8  --per_device_eval_batch_size 8  --gradient_accumulation_steps 1  --learning_rate 5e-5  --num_train_epochs 3.0  --evaluation_strategy \"epoch\"  --logging_strategy \"epoch\"  --do_train  --do_predict  --predict_with_generate  --overwrite_output_dir  --output_dir \"./outputs\"  --logging_dir \"./logs\"  --ddp_find_unused_parameters False\n",
                "environmentId": "[resourceId('Microsoft.MachineLearningServices/workspaces/environments/versions', parameters('workspaces_txtsumdemo_name'), 'hf-gpu', '1')]",
                "inputDataBindings": {
                    "corpus": {
                        "dataId": "[resourceId('Microsoft.MachineLearningServices/workspaces/data/versions', parameters('workspaces_txtsumdemo_name'), 'hf-samsum', '1')]",
                        "mode": "Download"
                    }
                },
                "outputDataBindings": {},
                "distribution": {
                    "distributionType": "PyTorch",
                    "processCount": 8
                },
                "environmentVariables": {}
            }
        }
    ]
}