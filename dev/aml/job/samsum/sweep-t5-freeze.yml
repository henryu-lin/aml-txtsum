$schema: https://azuremlschemas.azureedge.net/latest/sweepJob.schema.json
experiment_name: hf-sweep
description: samsum param freezing
type: sweep_job
algorithm: grid
trial:
    code: 
        local_path: ../../src
    command: >
        deepspeed trainer-wip.py 
        --deepspeed "./configs/ds_zero2.json" 
        --model_name_or_path "t5-large" 
        --config_name "./configs/t5-large-config.json" 
        --dataset_name "samsum" 
        --dataset_path {inputs.corpus} 
        --source_prefix "summarize: " 
        --max_source_length 512 
        --max_target_length 90 
        --fp16 True 
        --seed 1 
        --per_device_train_batch_size 8 
        --per_device_eval_batch_size 8 
        --gradient_accumulation_steps 1 
        --learning_rate 5e-5 
        --num_train_epochs 3.0 
        --weight_decay 0.1 
        --evaluation_strategy "epoch"
        --logging_strategy "epoch" 
        --freeze_embeds {search_space.freeze_embeds} 
        --freeze_encoder {search_space.freeze_encoder} 
        --do_train 
        --do_predict 
        --save_strategy "no"
        --predict_with_generate 
        --overwrite_output_dir 
        --output_dir "./outputs" 
        --logging_dir "./logs" 
    environment: azureml:hf-deepspeed:3
    inputs:
        corpus:
            data: azureml:hf-samsum:1
            mode: download
    compute:
        target: azureml:gpu-v100-8-lp
        instance_count: 1
search_space:
    freeze_embeds:
        type: choice
        values: [0, 1]
    freeze_encoder:
        type: choice
        values: [0, 1]
objective:
    primary_metric: eval_rouge1
    goal: maximize
max_total_trials: 4
max_concurrent_trials: 1
timeout_minutes: 900