{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaces_txtsumaml_name": {
            "defaultValue": "txtsumaml",
            "type": "String"
        },
        "storageaccounts_txtsumamlstorage_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.storage/storageaccounts/txtsumamlstorage",
            "type": "String"
        },
        "vaults_txtsumamlkeyvault_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.keyvault/vaults/txtsumamlkeyvault",
            "type": "String"
        },
        "components_txtsumamlinsights_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.insights/components/txtsumamlinsights",
            "type": "String"
        },
        "registries_txtsumamlregistry_externalid": {
            "defaultValue": "/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/uw-embeddings/providers/microsoft.containerregistry/registries/txtsumamlregistry",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.MachineLearningServices/workspaces",
            "apiVersion": "2021-04-01",
            "name": "[parameters('workspaces_txtsumaml_name')]",
            "location": "westus2",
            "sku": {
                "name": "Basic",
                "tier": "Basic"
            },
            "identity": {
                "principalId": "06f290f1-6365-4a18-9ff3-62f9284406a8",
                "tenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
                "type": "SystemAssigned"
            },
            "properties": {
                "friendlyName": "[parameters('workspaces_txtsumaml_name')]",
                "storageAccount": "[parameters('storageaccounts_txtsumamlstorage_externalid')]",
                "keyVault": "[parameters('vaults_txtsumamlkeyvault_externalid')]",
                "applicationInsights": "[parameters('components_txtsumamlinsights_externalid')]",
                "hbiWorkspace": false,
                "containerRegistry": "[parameters('registries_txtsumamlregistry_externalid')]",
                "allowPublicAccessWhenBehindVnet": false,
                "discoveryUrl": "https://westus2.api.azureml.ms/discovery"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('workspaces_txtsumaml_name'), '/gpu-v100-8-lp')]",
            "location": "westus2",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumaml_name'))]"
            ],
            "properties": {
                "disableLocalAuth": false,
                "computeType": "AmlCompute",
                "computeLocation": "westus2",
                "properties": {
                    "vmSize": "STANDARD_ND40RS_V2",
                    "vmPriority": "LowPriority",
                    "scaleSettings": {
                        "maxNodeCount": 1,
                        "minNodeCount": 0,
                        "nodeIdleTimeBeforeScaleDown": "PT5M"
                    },
                    "remoteLoginPortPublicAccess": "Enabled",
                    "osType": "Linux",
                    "isolatedNetwork": false
                }
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumaml_name'), '/workspaceblobstore')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumaml_name'))]"
            ],
            "properties": {
                "contents": {
                    "contentsType": "AzureBlob",
                    "accountName": "txtsumamlstorage",
                    "containerName": "azureml-blobstore-132c48a6-c6bb-45cd-a73c-b59edf519b7a",
                    "endpoint": "core.windows.net",
                    "protocol": "https",
                    "credentials": {
                        "credentialsType": "AccountKey"
                    }
                },
                "isDefault": true
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumaml_name'), '/workspacefilestore')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumaml_name'))]"
            ],
            "properties": {
                "contents": {
                    "contentsType": "AzureFile",
                    "accountName": "txtsumamlstorage",
                    "containerName": "azureml-filestore-132c48a6-c6bb-45cd-a73c-b59edf519b7a",
                    "endpoint": "core.windows.net",
                    "protocol": "https",
                    "credentials": {
                        "credentialsType": "AccountKey"
                    }
                },
                "isDefault": false
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/environments",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumaml_name'), '/hf-zero-gpu')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumaml_name'))]"
            ],
            "properties": {
                "properties": {},
                "tags": {}
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/environments/versions",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspaces_txtsumaml_name'), '/hf-zero-gpu/1')]",
            "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces/environments', parameters('workspaces_txtsumaml_name'), 'hf-zero-gpu')]",
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('workspaces_txtsumaml_name'))]"
            ],
            "properties": {
                "tags": {},
                "properties": {},
                "isAnonymous": false,
                "docker": {
                    "platform": {
                        "operatingSystemType": "Linux"
                    },
                    "dockerSpecificationType": "Image",
                    "dockerImageUri": "mcr.microsoft.com/azureml/openmpi4.1.0-cuda11.1-cudnn8-ubuntu18.04:latest"
                },
                "condaFile": "{\n  \"channels\": [\n    \"pytorch\",\n    \"nvidia\",\n    \"conda-forge\"\n  ],\n  \"dependencies\": [\n    \"python=3.8\",\n    \"pytorch=1.9.0\",\n    \"cudatoolkit=11.1\",\n    \"pip\",\n    {\n      \"pip\": [\n        \"numpy\",\n        \"nltk\",\n        \"protobuf\",\n        \"py7zr\",\n        \"sentencepiece\",\n        \"datasets\",\n        \"git+https://github.com/huggingface/transformers\",\n        \"rouge-score\",\n        \"mlflow\",\n        \"azureml-mlflow\",\n        \"codecarbon\",\n        \"deepspeed\",\n        \"fairscale\"\n      ]\n    }\n  ],\n  \"name\": \"azureml_8db0ad68ca506622653cab01e942c9da\"\n}"
            }
        }
    ]
}