{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "linydub-dev",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure monitor",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"d21de4a5-9053-4169-9e8a-0573bcd3cca6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workspace\",\"label\":\"AzureML Workspace\",\"type\":2,\"isRequired\":true,\"query\":\"Resources\\r\\n| where type =~ 'Microsoft.MachineLearningServices/workspaces'\",\"crossComponentResources\":[\"value::all\"],\"value\":\"/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/UW-Embeddings/providers/Microsoft.MachineLearningServices/workspaces/TxtsumDemo\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7ad643bf-baef-4063-8b40-8fd0bb521f84\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"mlflowApi\",\"label\":\"MLflow Rest API\",\"type\":1,\"isRequired\":true,\"query\":\"Resources\\r\\n| where name == \\\"{workspace:label}\\\"\\r\\n| project mlflow = strcat('https', trim_start('azureml', tostring(properties.mlFlowTrackingUri)), '/api/2.0/mlflow')\",\"crossComponentResources\":[\"value::all\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"93ecf6f1-c00e-4e01-acf0-5303ca077c37\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"accessToken\",\"label\":\"Access token\",\"type\":1,\"description\":\"Warning: The access token is only hidden on UI when user types. The token is still fully accessible as a param value when referred and it is stored unencrypted when workbook is saved.\",\"isRequired\":true,\"isHiddenWhenLocked\":true,\"typeSettings\":{\"isPassword\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":\"TOKEN_SECRET\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3178f8cb-305f-4c65-98ec-26a38b899dfb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"experiment\",\"label\":\"Experiment\",\"type\":2,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[{\\\"key\\\":\\\"Authorization\\\",\\\"value\\\":\\\"Bearer {accessToken}\\\"}],\\\"method\\\":\\\"GET\\\",\\\"url\\\":\\\"{mlflowApi}/experiments/list\\\",\\\"contentType\\\":\\\"text/plain\\\",\\\"urlParams\\\":[],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.experiments\\\",\\\"columns\\\":[]}}]}\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":10,\"value\":null},{\"id\":\"e1277afe-b409-4c6c-a39c-8d5aa7544732\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"run\",\"type\":2,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":\\\"{}\\\",\\\"headers\\\":[{\\\"key\\\":\\\"Authorization\\\",\\\"value\\\":\\\"Bearer {accessToken}\\\"}],\\\"method\\\":\\\"POST\\\",\\\"url\\\":\\\"{mlflowApi}/runs/search\\\",\\\"contentType\\\":\\\"application/json\\\",\\\"urlParams\\\":[],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$..runs[?(@.info.experiment_id==\\\\\\\"{experiment}\\\\\\\")]\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.info\\\",\\\"columnid\\\":\\\"runInfo\\\"},{\\\"path\\\":\\\"$..run_id\\\",\\\"columnid\\\":\\\"runId\\\",\\\"columnType\\\":\\\"string\\\"}]}}]}\",\"value\":\"{\\\"run_uuid\\\":\\\"bart-samsum-pytorch\\\",\\\"experiment_id\\\":\\\"18b83b4f-ae44-4575-b62f-6a12301bee69\\\",\\\"user_id\\\":\\\"bcebe9dd-feef-4d42-88df-0fc3101b8f29\\\",\\\"status\\\":\\\"FINISHED\\\",\\\"start_time\\\":\\\"1630201570820\\\",\\\"end_time\\\":\\\"1630202079043\\\",\\\"lifecycle_stage\\\":\\\"active\\\",\\\"run_id\\\":\\\"bart-samsum-pytorch\\\"}\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":10},{\"id\":\"bf2b43a3-d910-4c4d-ba2d-1c978a3e36f2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"runId\",\"type\":1,\"isRequired\":true,\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"rightValType\":\"param\",\"resultValType\":\"static\",\"resultVal\":\"{run:label}\"}}],\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"cf659eaa-d48f-4076-b0d6-75b7f34f77eb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeTest\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{workspace}/providers/Microsoft.Insights/metrics\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2021-05-01\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.timespan\\\",\\\"columns\\\":[]}}]}\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":12},{\"id\":\"873c34ce-1add-4b6b-adfc-0404f8745b95\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"mlflowMetric\",\"type\":2,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[{\\\"key\\\":\\\"Authorization\\\",\\\"value\\\":\\\"Bearer {accessToken}\\\"}],\\\"method\\\":\\\"GET\\\",\\\"url\\\":\\\"{mlflowApi}/runs/get\\\",\\\"contentType\\\":\\\"text/plain\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"run_id\\\",\\\"value\\\":\\\"{runId}\\\"}],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$..metrics.*\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.value\\\",\\\"columnid\\\":\\\"value\\\"},{\\\"path\\\":\\\"$.key\\\",\\\"columnid\\\":\\\"key\\\"},{\\\"path\\\":\\\"$.timestamp\\\",\\\"columnid\\\":\\\"timestamp\\\"}]}}]}\",\"value\":\"54.6725\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":10}],\"style\":\"above\",\"queryType\":12},\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"{mlflowMetric:label}: {mlflowMetric:value}\",\"style\":\"info\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[{\\\"key\\\":\\\"Authorization\\\",\\\"value\\\":\\\"Bearer {accessToken}\\\"}],\\\"method\\\":\\\"GET\\\",\\\"url\\\":\\\"{mlflowApi}/metrics/get-history\\\",\\\"contentType\\\":\\\"text/plain\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"run_id\\\",\\\"value\\\":\\\"{runId}\\\"},{\\\"key\\\":\\\"metric_key\\\",\\\"value\\\":\\\"{mlflowMetric:label}\\\"}],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.metrics\\\",\\\"columns\\\":[]}}]}\",\"size\":1,\"queryType\":10},\"name\":\"query - 5\"},{\"type\":10,\"content\":{\"chartId\":\"workbook9b73731f-cae5-46f9-a959-1742eb8065bb\",\"version\":\"MetricsItem/2.0\",\"size\":4,\"chartType\":-1,\"resourceType\":\"microsoft.machinelearningservices/workspaces\",\"metricScope\":0,\"resourceParameter\":\"workspace\",\"resourceIds\":[\"{workspace}\"],\"timeContext\":{\"durationMs\":604800000},\"metrics\":[{\"namespace\":\"microsoft.machinelearningservices/workspaces\",\"metric\":\"microsoft.machinelearningservices/workspaces-Resource-GpuEnergyJoules\",\"aggregation\":1,\"splitBy\":\"runId\",\"splitBySortOrder\":-1,\"splitByLimit\":5},{\"namespace\":\"microsoft.machinelearningservices/workspaces\",\"metric\":\"microsoft.machinelearningservices/workspaces-Resource-GpuUtilization\",\"aggregation\":4,\"splitBy\":\"runId\",\"splitBySortOrder\":-1,\"splitByLimit\":5}],\"gridFormatType\":1,\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Metric\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"mapSettings\":{\"locInfo\":\"AzureResource\",\"sizeSettings\":\"Value\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Value\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Value\",\"heatmapPalette\":\"greenRed\"},\"locInfoColumn\":\"Name\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Subscription\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Value\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"filters\":[{\"id\":\"2\",\"key\":\"runId\",\"operator\":0,\"valueParam\":\"runId\"}],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}},{\"columnMatch\":\"microsoft.machinelearningservices/workspaces-Resource-GpuEnergyJoules\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":null}},{\"columnMatch\":\"microsoft.machinelearningservices/workspaces-Resource-GpuEnergyJoules Timeline\",\"formatter\":5},{\"columnMatch\":\"Metric\",\"formatter\":1},{\"columnMatch\":\"Aggregation\",\"formatter\":1},{\"columnMatch\":\"Value\",\"formatter\":1},{\"columnMatch\":\"Timeline\",\"formatter\":9},{\"columnMatch\":\"microsoft.machinelearningservices/workspaces-Resource-GpuUtilization\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":null}},{\"columnMatch\":\".*\\\\/GpuEnergyJoules$\",\"formatter\":1}],\"rowLimit\":10000,\"labelSettings\":[{\"columnId\":\"Subscription\"},{\"columnId\":\"Name\",\"label\":\"Workspace\"},{\"columnId\":\"Segment\",\"label\":\"Run ID\"},{\"columnId\":\"microsoft.machinelearningservices/workspaces-Resource-GpuEnergyJoules\",\"label\":\"GpuEnergyJoules (Sum)\"},{\"columnId\":\"microsoft.machinelearningservices/workspaces-Resource-GpuEnergyJoules Timeline\",\"label\":\"GpuEnergyJoules (Sum) Timeline\"},{\"columnId\":\"microsoft.machinelearningservices/workspaces-Resource-GpuUtilization\",\"label\":\"GpuUtilization (Average)\"},{\"columnId\":\"microsoft.machinelearningservices/workspaces-Resource-GpuUtilization Timeline\",\"label\":\"GpuUtilization (Average) Timeline\"}]}},\"name\":\"metric - 3\"},{\"type\":10,\"content\":{\"chartId\":\"workbookf5d33b9f-2209-415e-90dd-479019c05a93\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":0,\"resourceType\":\"microsoft.machinelearningservices/workspaces\",\"metricScope\":0,\"resourceIds\":[\"/subscriptions/6560575d-fa06-4e7d-95fb-f962e74efd7a/resourceGroups/UW-Embeddings/providers/Microsoft.MachineLearningServices/workspaces/TxtsumDev\"],\"timeContext\":{\"durationMs\":604800000},\"metrics\":[{\"namespace\":\"microsoft.machinelearningservices/workspaces\",\"metric\":\"microsoft.machinelearningservices/workspaces-Resource-GpuMemoryUtilizationMegabytes\",\"aggregation\":4,\"splitBy\":\"DeviceId\",\"splitBySortOrder\":false,\"splitByLimit\":5,\"columnName\":\"GPU Memory (Megabytes)\"}],\"gridFormatType\":2,\"filters\":[{\"id\":\"1\",\"key\":\"RunId\",\"operator\":0,\"valueParam\":\"runId\"}],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\"}},{\"columnMatch\":\".*\\\\/GPU Memory (Megabytes)$\",\"formatter\":1},{\"columnMatch\":\"Metric\",\"formatter\":1},{\"columnMatch\":\"Aggregation\",\"formatter\":5},{\"columnMatch\":\"Value\",\"formatter\":1},{\"columnMatch\":\"Timeline\",\"formatter\":9},{\"columnMatch\":\"GPU Memory (Megabytes)\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":null}}],\"rowLimit\":10000,\"labelSettings\":[{\"columnId\":\"Name\",\"label\":\"Workspace\"},{\"columnId\":\"Segment\",\"label\":\"Device ID\"}]}},\"name\":\"metric - 4\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure monitor\"],\"fromTemplateId\":\"community-Workbooks/Azure Monitor - Getting Started/Resource Picker\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}